{% extends "base.html" %}

{% block title %}ì£¼ì‹ ì¶”ì  ëŒ€ì‹œë³´ë“œ - í•œêµ­ ì£¼ì‹ ì¶”ì ê¸°{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h1 class="card-title">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        ì£¼ì‹ ì¶”ì  ëŒ€ì‹œë³´ë“œ
                    </h1>
                    <p class="card-text text-muted">
                        ì¶”ì  ì¤‘ì¸ ì¢…ëª©ì˜ ì§ì „ ê³ ì  ëŒ€ë¹„ í•˜ë½ë¥ ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¢…ëª© ì¶”ê°€ ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        ìƒˆ ì¢…ëª© ì¶”ê°€
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ì¢…ëª© ê²€ìƒ‰ ì„¹ì…˜ -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="stock_search" class="form-label">ì¢…ëª© ê²€ìƒ‰</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="stock_search" 
                                       placeholder="ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±ì „ì, ë„¤ì´ë²„, ì¹´ì¹´ì˜¤)" 
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="search_btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="search_results" class="mt-2" style="display: none;">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div id="search_results_list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì¸ê¸° ì¢…ëª© ë²„íŠ¼ë“¤ -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">ì¸ê¸° ì¢…ëª©:</small>
                            <div class="mt-1" id="popular_stocks">
                                <!-- í•œêµ­ ì£¼ì‹ -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">ğŸ‡°ğŸ‡· í•œêµ­:</small>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-1 mb-1" data-code="005930" data-name="ì‚¼ì„±ì „ì">ì‚¼ì„±ì „ì</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-1 mb-1" data-code="000660" data-name="SKí•˜ì´ë‹‰ìŠ¤">SKí•˜ì´ë‹‰ìŠ¤</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-1 mb-1" data-code="035420" data-name="NAVER">NAVER</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-1 mb-1" data-code="035720" data-name="ì¹´ì¹´ì˜¤">ì¹´ì¹´ì˜¤</button>
                                </div>
                                <!-- ë¯¸êµ­ ì£¼ì‹ -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">ğŸ‡ºğŸ‡¸ ë¯¸êµ­:</small>
                                    <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1" data-code="AAPL" data-name="Apple">Apple</button>
                                    <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1" data-code="MSFT" data-name="Microsoft">Microsoft</button>
                                    <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1" data-code="GOOGL" data-name="Google">Google</button>
                                    <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1" data-code="TSLA" data-name="Tesla">Tesla</button>
                                    <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1" data-code="NVDA" data-name="NVIDIA">NVIDIA</button>
                                </div>
                                <!-- ì¼ë³¸ ì£¼ì‹ -->
                                <div class="mb-2">
                                    <small class="text-muted d-block">ğŸ‡¯ğŸ‡µ ì¼ë³¸:</small>
                                    <button type="button" class="btn btn-outline-warning btn-sm me-1 mb-1" data-code="7203.T" data-name="Toyota">ë„ìš”íƒ€</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm me-1 mb-1" data-code="6758.T" data-name="Sony">ì†Œë‹ˆ</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm me-1 mb-1" data-code="7974.T" data-name="Nintendo">ë‹Œí…ë„</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm me-1 mb-1" data-code="9984.T" data-name="SoftBank">ì†Œí”„íŠ¸ë±…í¬</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì¢…ëª© ì¶”ê°€ í¼ -->
                    <form method="POST" action="{{ url_for('add_stock') }}" class="row g-3">
                        <div class="col-md-4">
                            <label for="stock_code" class="form-label">ì¢…ëª© ì½”ë“œ</label>
                            <input type="text" class="form-control" id="stock_code" name="stock_code" 
                                   placeholder="ì˜ˆ: 005930" required readonly>
                            <div class="form-text">ìœ„ì—ì„œ ì¢…ëª©ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”</div>
                        </div>
                        <div class="col-md-4">
                            <label for="stock_name" class="form-label">ì¢…ëª©ëª…</label>
                            <input type="text" class="form-control" id="stock_name" name="stock_name" 
                                   placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" required readonly>
                            <div class="form-text">ì¢…ëª© ì½”ë“œì™€ í•¨ê»˜ ìë™ ì…ë ¥ë©ë‹ˆë‹¤</div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" id="add_stock_btn" disabled>
                                <i class="fas fa-plus me-2"></i>
                                ì¢…ëª© ì¶”ê°€
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì¹´ë“œ ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary">
                <div class="card-body text-center text-white">
                    <i class="fas fa-list fa-2x mb-2"></i>
                    <h4>{{ stocks|length }}</h4>
                    <p class="mb-0">ì¶”ì  ì¢…ëª©</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success">
                <div class="card-body text-center text-white">
                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                    <h4>{{ stocks|selectattr('decline_status', 'equalto', 'low')|list|length }}</h4>
                    <p class="mb-0">ë‚®ì€ í•˜ë½ë¥  (5% ë¯¸ë§Œ)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning">
                <div class="card-body text-center text-white">
                    <i class="fas fa-minus fa-2x mb-2"></i>
                    <h4>{{ stocks|selectattr('decline_status', 'equalto', 'medium')|list|length }}</h4>
                    <p class="mb-0">ì¤‘ê°„ í•˜ë½ë¥  (5-15%)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger">
                <div class="card-body text-center text-white">
                    <i class="fas fa-arrow-down fa-2x mb-2"></i>
                    <h4>{{ stocks|selectattr('decline_status', 'equalto', 'high')|list|length }}</h4>
                    <p class="mb-0">ë†’ì€ í•˜ë½ë¥  (15% ì´ìƒ)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¶”ì  ì¢…ëª© ëª©ë¡ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        ì¶”ì  ì¢…ëª© ëª©ë¡
                    </h5>
                    <a href="{{ url_for('refresh_data') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync me-1"></i>
                        ì „ì²´ ìƒˆë¡œê³ ì¹¨
                    </a>
                </div>
                <div class="card-body">
                    {% if stocks %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ì¢…ëª©ëª…</th>
                                        <th>ì‹œì¥</th>
                                        <th>ì¢…ëª©ì½”ë“œ</th>
                                        <th class="text-end">í˜„ì¬ê°€</th>
                                        <th class="text-end">ìµœê·¼ ê³ ì </th>
                                        <th>ê³ ì  ë‚ ì§œ</th>
                                        <th class="text-end">í•˜ë½ë¥ </th>
                                        <th>ìµœì¢… ì—…ë°ì´íŠ¸</th>
                                        <th>ìƒíƒœ</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock in stocks %}
                                    <tr class="{% if stock.status == 'error' %}table-danger{% endif %}">
                                        <td>
                                            <strong>{{ stock.name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if stock.market_type == 'KRX' %}primary{% elif stock.market_type == 'US' %}success{% elif stock.market_type == 'TSE' %}warning{% else %}secondary{% endif %}">
                                                {{ stock.market_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <code>{{ stock.original_code or stock.code }}</code>
                                        </td>
                                        <td class="text-end">
                                            {% if stock.current_price_formatted %}
                                                {{ stock.current_price_formatted }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if stock.recent_high_formatted %}
                                                {{ stock.recent_high_formatted }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if stock.recent_high_date %}
                                                {{ stock.recent_high_date }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if stock.decline_rate_formatted %}
                                                <span class="badge bg-{% if stock.decline_status == 'low' %}success{% elif stock.decline_status == 'medium' %}warning{% else %}danger{% endif %} fs-6">
                                                    {{ stock.decline_rate_formatted }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if stock.last_updated_formatted %}
                                                <small class="text-muted">{{ stock.last_updated_formatted }}</small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if stock.status == 'error' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    ì˜¤ë¥˜
                                                </span>
                                                {% if stock.error_message %}
                                                    <br><small class="text-muted">{{ stock.error_message[:50] }}...</small>
                                                {% endif %}
                                            {% elif stock.status == 'no_data' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-question-circle me-1"></i>
                                                    ë°ì´í„° ì—†ìŒ
                                                </span>
                                            {% elif stock.status == 'outdated' %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-clock me-1"></i>
                                                    ì—…ë°ì´íŠ¸ í•„ìš”
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>
                                                    ì •ìƒ
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('remove_stock', stock_code=stock.code) }}" 
                                               class="btn btn-outline-danger btn-sm"
                                               onclick="return confirm('{{ stock.name }} ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">ì¶”ì  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p class="text-muted">ìœ„ì˜ í¼ì„ ì‚¬ìš©í•˜ì—¬ ì²« ë²ˆì§¸ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ë„ì›€ë§ ì„¹ì…˜ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        ì‚¬ìš©ë²• ì•ˆë‚´
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-plus me-2 text-primary"></i>ì¢…ëª© ì¶”ê°€</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check me-2 text-success"></i>6ìë¦¬ ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 005930)</li>
                                <li><i class="fas fa-check me-2 text-success"></i>ì •í™•í•œ ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</li>
                                <li><i class="fas fa-check me-2 text-success"></i>ìë™ìœ¼ë¡œ .KSê°€ ì¶”ê°€ë©ë‹ˆë‹¤</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line me-2 text-info"></i>í•˜ë½ë¥  ê³„ì‚°</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-info me-2 text-info"></i>ìµœê·¼ 3ê°œì›” ë‚´ ìµœê³ ê°€ ê¸°ì¤€</li>
                                <li><i class="fas fa-info me-2 text-info"></i>ì‹¤ì‹œê°„ ì¢…ê°€ ëŒ€ë¹„ ê³„ì‚°</li>
                                <li><i class="fas fa-info me-2 text-info"></i>í•˜ë½ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ êµ¬ë¶„</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ìë™ ìƒˆë¡œê³ ì¹¨ (10ë¶„ë§ˆë‹¤)
    setInterval(function() {
        console.log('ìë™ ìƒˆë¡œê³ ì¹¨ í™•ì¸ ì¤‘...');
        // ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì£¼ì„ í•´ì œ
        // window.location.reload();
    }, 600000); // 10ë¶„
</script>
{% endblock %}
