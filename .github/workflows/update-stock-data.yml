name: Update Stock Data

on:
  schedule:
    # í‰ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)
    - cron: '0 0 * * 1-5'
    # í‰ì¼ í•œêµ­ì‹œê°„ ì˜¤í›„ 3ì‹œ 30ë¶„ (UTC 6ì‹œ 30ë¶„)
    - cron: '30 6 * * 1-5'
    # ë§¤ì¼ ì˜¤í›„ 6ì‹œ (UTC 9ì‹œ)
    - cron: '0 9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main, master ]
    paths:
      - 'data/stocks.json'
      - '.github/workflows/update-stock-data.yml'

permissions:
  contents: write
  pages: write
  actions: read

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance requests flask
    
    - name: Create update script
      run: |
        cat > auto_update.py << 'EOF'
        import sys
        import os
        sys.path.append(os.getcwd())

        try:
            from stock_tracker import StockTracker
            import logging

            logging.basicConfig(level=logging.INFO)
            tracker = StockTracker()

            print(f'í˜„ìž¬ ì¶”ì  ì¤‘ì¸ ì¢…ëª© ìˆ˜: {len(tracker.stocks)}')

            if len(tracker.stocks) > 0:
                try:
                    updated_count = tracker.refresh_all_stocks()
                    print(f'ì—…ë°ì´íŠ¸ëœ ì¢…ëª© ìˆ˜: {updated_count}')
                    
                    stocks = tracker.get_tracked_stocks()
                    for stock in stocks:
                        name = stock.get('name', '')
                        decline = stock.get('decline_rate_formatted', 'N/A')
                        status = stock.get('decline_status', 'unknown')
                        print(f'{name}: {decline} ({status})')
                except Exception as e:
                    print(f'ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}')
            else:
                print('ì¶”ì  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.')
                
        except ImportError as e:
            print(f'ëª¨ë“ˆ import ì˜¤ë¥˜: {e}')
            print('í•„ìš”í•œ íŒŒì¼ë“¤ì´ ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.')
        except Exception as e:
            print(f'ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}')
        EOF

    - name: Run stock data update
      run: |
        echo "Starting stock data update..."
        python auto_update.py
    
    - name: Generate static HTML
      run: |
        echo "Generating static HTML for GitHub Pages..."
        python static_export.py
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
          git status
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git add data/stocks.json docs/
        git commit -m "Auto-update stock data - $(date '+%Y-%m-%d %H:%M:%S UTC')"
        git push
    
    - name: Create summary script
      run: |
        cat > create_summary.py << 'EOF'
        from stock_tracker import StockTracker
        import json
        from datetime import datetime

        tracker = StockTracker()
        stocks = tracker.get_tracked_stocks()

        if stocks:
            low_count = len([s for s in stocks if s.get('decline_status') == 'low'])
            medium_count = len([s for s in stocks if s.get('decline_status') == 'medium'])
            high_count = len([s for s in stocks if s.get('decline_status') == 'high'])
            
            print(f'**ì´ ì¶”ì  ì¢…ëª©:** {len(stocks)}ê°œ')
            print(f'**ì£¼ì˜ê¶Œ (10% ì´í•˜):** {low_count}ê°œ')
            print(f'**ê²½ê³ ê¶Œ (10-30%):** {medium_count}ê°œ')
            print(f'**ë°œë™ê¶Œ (30% ì´ìƒ):** {high_count}ê°œ')
            print('')
            print('### ðŸ“ˆ ì¢…ëª©ë³„ í˜„í™©')
            print('| ì¢…ëª©ëª… | í˜„ìž¬ê°€ | ê³ ì  | í•˜ë½ë¥  | ìƒíƒœ |')
            print('|--------|--------|------|--------|------|')
            
            for stock in sorted(stocks, key=lambda x: x.get('decline_rate', 0) or 0, reverse=True):
                name = stock.get('name', 'N/A')
                current = stock.get('current_price_formatted', 'N/A')
                high = stock.get('recent_high_formatted', 'N/A')
                decline = stock.get('decline_rate_formatted', 'N/A')
                status_map = {'low': 'ì£¼ì˜ê¶Œ', 'medium': 'ê²½ê³ ê¶Œ', 'high': 'ë°œë™ê¶Œ'}
                status = status_map.get(stock.get('decline_status'), 'N/A')
                print(f'| {name} | {current} | {high} | {decline} | {status} |')
        else:
            print('ì¶”ì  ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.')
        EOF

    - name: Create summary
      run: |
        echo "## ðŸ“Š Stock Data Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Update Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python create_summary.py >> $GITHUB_STEP_SUMMARY